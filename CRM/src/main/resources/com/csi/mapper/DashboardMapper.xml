<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csi.mapper.DashboardMapper">

    <!-- 总销售额查询 -->
    <select id="getTotalSales" resultType="java.lang.Double">
        SELECT SUM(total_amount) FROM orders WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()
    </select>

    <!-- 总订单数查询 -->
    <select id="getTotalOrders" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM orders WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()
    </select>

    <!-- 新增客户数查询 -->
    <select id="getNewCustomers" resultType="java.lang.Integer">
        SELECT COUNT(*) FROM customers WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()
    </select>

    <!-- 转化率查询（订单数/客户数） -->
    <select id="getConversionRate" resultType="java.lang.Double">
        SELECT (
            SELECT COUNT(*) FROM orders WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()
        ) / (
            SELECT COUNT(*) FROM customers WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()
        ) * 100
    </select>

    <!-- 销售趋势数据（最近6个月） -->
    <select id="getSalesTrendData" resultType="com.csi.domain.SalesData">
        SELECT DATE_FORMAT(create_time, '%Y-%m') AS month,
               SUM(total_amount) AS sales,
               COUNT(*) AS orders
        FROM orders
        WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 6 MONTH) AND NOW()
        GROUP BY DATE_FORMAT(create_time, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- 客户来源分布 -->
    <select id="getCustomerSources" resultType="com.csi.domain.CustomerSource">
        SELECT source AS name, COUNT(*) AS value
        FROM customers
        GROUP BY source
        ORDER BY value DESC
    </select>


    <!-- 商机转化率漏斗数据 -->
    <select id="getOpportunityConversions" resultType="com.csi.domain.OpportunityConversion">
        SELECT stage, COUNT(*) AS value,
               COUNT(*) / (SELECT COUNT(*) FROM opportunities) * 100 AS percentage
        FROM opportunities
        GROUP BY stage
        ORDER BY CASE stage WHEN '线索' THEN 1 WHEN '商机' THEN 2 WHEN '提案' THEN 3 WHEN '谈判' THEN 4 WHEN '成交' THEN 5 ELSE 6 END
    </select>

    <!-- 客户类型分布 -->
    <select id="getCustomerTypes" resultType="com.csi.domain.CustomerType">
        SELECT status AS type, COUNT(*) AS count,
               COUNT(*) / (SELECT COUNT(*) FROM customers) * 100 AS percentage
        FROM customers
        GROUP BY status
        ORDER BY count DESC
    </select>

    <!-- 销售业绩排行 -->
    <select id="getSalesRanks" resultType="com.csi.domain.SalesRank">
        SELECT e.name AS salesperson, SUM(o.total_amount) AS salesAmount
        FROM orders o
                 JOIN opportunities op ON o.opportunity_id = op.id
                 JOIN employees e ON op.assignee_id = e.id
        WHERE o.create_time BETWEEN DATE_SUB(NOW(), INTERVAL 30 DAY) AND NOW()
        GROUP BY e.id
        ORDER BY salesAmount DESC
        LIMIT 6
    </select>

    <!-- 客户留存率分析数据 -->
    <select id="getRetentionData" resultType="com.csi.domain.RetentionData">
        SELECT DATE_FORMAT(c.create_time, '%Y-%m') AS month,
               AVG(CASE WHEN DATEDIFF(NOW(), c.create_time) BETWEEN 7 AND 14 THEN 1 ELSE 0 END) * 100 AS sevenDayRetention,
               AVG(CASE WHEN DATEDIFF(NOW(), c.create_time) BETWEEN 30 AND 45 THEN 1 ELSE 0 END) * 100 AS thirtyDayRetention,
               AVG(CASE WHEN DATEDIFF(NOW(), c.create_time) BETWEEN 90 AND 105 THEN 1 ELSE 0 END) * 100 AS ninetyDayRetention
        FROM customers c
        WHERE c.create_time BETWEEN DATE_SUB(NOW(), INTERVAL 6 MONTH) AND NOW()
        GROUP BY DATE_FORMAT(c.create_time, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- 客户生命周期价值分析数据 -->
    <select id="getCustomerLifetimeValues" resultType="com.csi.domain.CustomerLifetimeValue">
        SELECT DATE_FORMAT(o.create_time, '%Y-%m') AS month,
        AVG(CASE WHEN DATEDIFF(o.create_time, c.create_time)  &lt;= 30 THEN o.total_amount ELSE NULL END) AS newCustomerValue,
        AVG(CASE WHEN DATEDIFF(o.create_time, c.create_time) BETWEEN 31 AND 180 THEN o.total_amount ELSE NULL END) AS activeCustomerValue,
        AVG(CASE WHEN DATEDIFF(o.create_time, c.create_time) > 180 THEN o.total_amount ELSE NULL END) AS loyalCustomerValue
        FROM orders o
        JOIN customers c ON o.customer_id = c.id
        WHERE o.create_time BETWEEN DATE_SUB(NOW(), INTERVAL 6 MONTH) AND NOW()
        GROUP BY DATE_FORMAT(o.create_time, '%Y-%m')
        ORDER BY month ASC
    </select>

    <!-- 销售预测数据（最近9个月，包括未来3个月的预测） -->
    <select id="getForecastData" resultType="com.csi.domain.SalesData">
        SELECT month, sales, orders FROM (
            SELECT DATE_FORMAT(create_time, '%Y-%m') AS month,
                   SUM(total_amount) AS sales,
                   COUNT(*) AS orders
            FROM orders
            WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 6 MONTH) AND NOW()
            GROUP BY DATE_FORMAT(create_time, '%Y-%m')
            UNION ALL
            SELECT DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 1 MONTH), '%Y-%m') AS month,
                   (SELECT AVG(sales) FROM (
                       SELECT SUM(total_amount) AS sales FROM orders
                       WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 3 MONTH) AND NOW()
                       GROUP BY DATE_FORMAT(create_time, '%Y-%m')
                   ) t) * 1.1 AS sales,
                   (SELECT AVG(orders) FROM (
                       SELECT COUNT(*) AS orders FROM orders
                       WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 3 MONTH) AND NOW()
                       GROUP BY DATE_FORMAT(create_time, '%Y-%m')
                   ) t) * 1.1 AS orders
            UNION ALL
            SELECT DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 2 MONTH), '%Y-%m') AS month,
                   (SELECT AVG(sales) FROM (
                       SELECT SUM(total_amount) AS sales FROM orders
                       WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 3 MONTH) AND NOW()
                       GROUP BY DATE_FORMAT(create_time, '%Y-%m')
                   ) t) * 1.2 AS sales,
                   (SELECT AVG(orders) FROM (
                       SELECT COUNT(*) AS orders FROM orders
                       WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 3 MONTH) AND NOW()
                       GROUP BY DATE_FORMAT(create_time, '%Y-%m')
                   ) t) * 1.2 AS orders
            UNION ALL
            SELECT DATE_FORMAT(DATE_ADD(NOW(), INTERVAL 3 MONTH), '%Y-%m') AS month,
                   (SELECT AVG(sales) FROM (
                       SELECT SUM(total_amount) AS sales FROM orders
                       WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 3 MONTH) AND NOW()
                       GROUP BY DATE_FORMAT(create_time, '%Y-%m')
                   ) t) * 1.3 AS sales,
                   (SELECT AVG(orders) FROM (
                       SELECT COUNT(*) AS orders FROM orders
                       WHERE create_time BETWEEN DATE_SUB(NOW(), INTERVAL 3 MONTH) AND NOW()
                       GROUP BY DATE_FORMAT(create_time, '%Y-%m')
                   ) t) * 1.3 AS orders
        ) t
        ORDER BY month ASC
    </select>

</mapper>