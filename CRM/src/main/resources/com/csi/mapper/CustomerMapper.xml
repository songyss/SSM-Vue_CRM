<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csi.mapper.CustomerMapper">

    <!-- ================== 基础查询 ================== -->
    <select id="getAllCustomer" resultType="com.csi.domain.Customer">
        SELECT
        c.id,
        c.name,
        c.phone,
        c.sex,
        c.borndate,
        c.company,
        c.position,
        c.source AS source,
        c.status,
        s.status_name AS statusName,
        c.notes,
        c.sdr_status,
        ss.sdr_status_name AS sdrStatusName,
        c.sdr_notes,
        c.assignee_id AS assigneeId,
        e1.name AS name1,
        c.creator_id AS creatorId,
        e2.name AS name2,
        c.last_follow_up_time AS lastFollowUpTime,
        c.create_time AS createTime,
        c.update_time AS updateTime,
        c.is_pool AS isPool,
        c.pool_time AS poolTime,
        c.activity_id AS activityId
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.assignee_id IS NULL
        AND COALESCE(c.is_pool, 0) = 0
    </select>


    <!-- 销售经理查看除未联系之外的客户 -->
    <select id="getAllSaleCustomer" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.sdr_status != 1
    </select>

    <!-- 已分配且有意向客户 -->
    <select id="getAssignedCustomer" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.assignee_id IS NOT NULL
        AND c.sdr_status = 3
    </select>

    <!-- 无意向客户 -->
    <select id="getNoIntentionCustomer" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.sdr_status = 2
    </select>

    <!-- 信息有误客户 -->
    <select id="getInfoIncorrectCustomer" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.sdr_status = 4
    </select>

    <!-- 根据来源筛选 -->
    <select id="getCustomerBySource" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.source LIKE CONCAT('%', #{source}, '%')
    </select>

    <!-- 修改客户状态 -->
    <update id="changeCustomerStatus">
        UPDATE customers SET status = #{status} WHERE id = #{id}
    </update>

    <!-- 新增客户 -->
    <insert id="addCustomer" parameterType="com.csi.domain.Customer">
        INSERT INTO customers (
        name, phone, sex, borndate,
        company, position, source,
        status, notes, assignee_id,
        creator_id, is_pool, activity_id, sdr_status
        ) VALUES (
        #{name}, #{phone}, #{sex}, #{borndate},
        #{company}, #{position}, #{source},
        #{status}, #{notes}, #{assigneeId},
        #{creatorId}, #{isPool}, #{activityId}, #{sdrStatus}
        )
    </insert>

    <!-- 更新客户 -->
    <update id="updateCustomer" parameterType="com.csi.domain.Customer">
        UPDATE customers
        <set>
            <if test="name != null and name != ''">
                name = #{name},
            </if>
            <if test="phone != null and phone != ''">
                phone = #{phone},
            </if>
            <if test="sex != null and sex != ''">
                sex = #{sex},
            </if>
            <if test="borndate != null">
                borndate = #{borndate},
            </if>
            <if test="company != null and company != ''">
                company = #{company},
            </if>
            <if test="position != null and position != ''">
                position = #{position},
            </if>
            <if test="source != null and source != ''">
                source = #{source},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            <if test="notes != null">
                notes = #{notes},
            </if>
            <if test="assigneeId != null">
                assignee_id = #{assigneeId},
            </if>
            <if test="lastFollowUpTime != null">
                last_follow_up_time = #{lastFollowUpTime},
            </if>
            <if test="isPool != null">
                is_pool = #{isPool},
            </if>
            <if test="poolTime != null">
                pool_time = #{poolTime},
            </if>
        </set>
        WHERE id = #{id}
    </update>


    <!-- 员工负责客户 -->
    <select id="getPersonalCustomer" resultType="com.csi.domain.Customer">
        SELECT * FROM customers WHERE assignee_id = #{assigneeId}
    </select>

    <!-- 检查手机号是否存在 -->
    <select id="checkCustomerPhone" resultType="com.csi.domain.Customer">
        SELECT * FROM customers WHERE phone = #{phone}
    </select>

    <!-- 根据 ID 查询客户 -->
    <select id="findById" resultType="com.csi.domain.Customer">
        SELECT * FROM customers WHERE id = #{id}
    </select>

    <!-- SDR 状态客户 -->
    <select id="getCustomerBySdrStatus" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        WHERE c.sdr_status IN (1, 2, 3)
    </select>

    <!-- 更新 SDR 状态 -->
    <update id="updateCustomerSdrStatus">
        UPDATE customers
        SET sdr_status = #{param1},
        sdr_notes = #{param2}
        WHERE id = #{param3}
    </update>

    <!-- 条件查询 -->
    <select id="getCustomerByCondition" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE 1=1
        <if test="name != null and name != ''">
            AND c.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="phone != null and phone != ''">
            AND c.phone LIKE CONCAT('%', #{phone}, '%')
        </if>
        <if test="source != null and source != ''">
            AND c.source LIKE CONCAT('%', #{source}, '%')
        </if>
        <if test="status != null">
            AND c.status = #{status}
        </if>
    </select>

    <!-- 客户池 -->
    <select id="getPoolCustomer" resultType="com.csi.domain.Customer">
        SELECT c.id, c.name, c.phone, c.sex,
        c.pool_time AS poolTime,
        c.last_follow_up_time AS lastFollowUpTime,
        c.create_time AS createTime,
        c.update_time AS updateTime,
        c.notes, c.company, c.position
        FROM customers c
        WHERE c.is_pool = 1
    </select>

    <!-- 待分配客户 -->
    <select id="getUnAssignedCustomer" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.assignee_id IS NULL
        AND c.is_pool = 0
        <if test="status != null">
            AND c.status = #{status}
        </if>
    </select>

    <!-- 分配客户 -->
    <update id="assignCustomers" parameterType="map">
        UPDATE customers
        SET assignee_id = #{employeeId}
        WHERE id IN
        <foreach collection="customerIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 员工分配的客户 -->
    <select id="findByEmployee" resultType="com.csi.domain.vo.CustomerVO">
        SELECT * FROM public_customer_pool
        WHERE assignee_id = #{employeeId}
    </select>

    <!-- 所有客户 -->
    <select id="findAll" resultType="com.csi.domain.vo.CustomerVO">
        SELECT * FROM public_customer_pool
    </select>

    <!-- 客户详情（含订单、商机，一对多映射） -->
    <resultMap id="CustomerDetailMap" type="com.csi.domain.vo.CustomerDetailVO">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="phone" column="phone"/>
        <result property="sex" column="sex"/>
        <result property="companyName" column="companyName"/>
        <result property="position" column="position"/>
        <result property="salesRemark" column="salesRemark"/>

        <!-- 订单集合 -->
        <collection property="orders" ofType="com.csi.domain.vo.OrderVO">
            <id property="id" column="orderId"/>
            <result property="orderNumber" column="orderNumber"/>
            <result property="createTime" column="orderCreateTime"/>
        </collection>

        <!-- 商机集合 -->
        <collection property="opportunities" ofType="com.csi.domain.vo.OpportunityVO">
            <id property="id" column="opportunityId"/>
            <result property="name" column="opportunityName"/>
            <result property="stage" column="opportunityStage"/>
        </collection>
    </resultMap>

    <select id="getCustomerDetail" resultType="com.csi.domain.Customer">
        SELECT c.id, c.name, c.phone, c.sex,
        c.company, c.position, c.source, c.notes,
        c.status, s.status_name AS statusName,
        c.sdr_status, ss.sdr_status_name AS sdrStatusName, c.sdr_notes,
        c.assignee_id, e1.name AS assigneeName,
        c.creator_id, e2.name AS creatorName,
        c.last_follow_up_time AS lastFollowUpTime,
        c.create_time AS createTime, c.update_time AS updateTime
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.id = #{id}
    </select>


    <select id="listByEmployee" resultType="com.csi.domain.vo.CustomerVO">
        SELECT c.*, e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        WHERE c.assignee_id = #{employeeId}
        <if test="name != null and name != ''">
            AND c.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="phone != null and phone != ''">
            AND c.phone LIKE CONCAT('%', #{phone}, '%')
        </if>
        LIMIT #{offset}, #{limit}
    </select>

    <select id="countByEmployee" resultType="int">
        SELECT COUNT(*)
        FROM customers c
        WHERE c.assignee_id = #{employeeId}
        AND COALESCE(c.is_pool, 0) = 0
        <if test="name != null and name != ''">
            AND c.name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="phone != null and phone != ''">
            AND c.phone LIKE CONCAT('%', #{phone}, '%')
        </if>
    </select>

    <update id="updateIsPool">
        UPDATE customers
        SET is_pool = 1,
        update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 更新客户为客户池，并清空分配人 -->
    <update id="updateIsPoolAndClearAssignee" parameterType="long">
        UPDATE customers
        SET is_pool = 1,
        assignee_id = NULL,
        update_time = NOW()
        WHERE id = #{id}
    </update>

    <!-- 插入客户池原因 -->
    <insert id="insertPoolReason">
        INSERT INTO public_customer_pool (
        customer_id, reason, release_time, locked_until, locked_by, create_time
        ) VALUES (
        #{customerId}, #{reason}, #{releaseTime},
        DATE_ADD(NOW(), INTERVAL 7 DAY),   -- 默认锁定 7 天
        IFNULL(#{lockedBy}, 0),            -- 如果传 null，就存 0
        NOW()
        )
        ON DUPLICATE KEY UPDATE
        reason = VALUES(reason),
        release_time = VALUES(release_time),
        locked_until = VALUES(locked_until),
        locked_by = VALUES(locked_by),
        create_time = NOW()
    </insert>




    <select id="selectCustomerList" resultType="com.csi.domain.Customer">
        SELECT c.*, s.status_name, ss.sdr_status_name,
        e1.name AS assigneeName, e2.name AS creatorName
        FROM customers c
        LEFT JOIN status s ON c.status = s.status_id
        LEFT JOIN sdr_status ss ON c.sdr_status = ss.sdr_status_id
        LEFT JOIN employees e1 ON c.assignee_id = e1.id
        LEFT JOIN employees e2 ON c.creator_id = e2.id
        <where>
            <if test="name != null and name != ''">
                AND c.name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="phone != null and phone != ''">
                AND c.phone LIKE CONCAT('%', #{phone}, '%')
            </if>
        </where>
    </select>
    <!-- 客户详情 -->
    <select id="findDetail" parameterType="long" resultType="com.csi.domain.vo.CustomerDetailVO">
        SELECT
        c.id,
        c.name,
        c.phone,
        c.sex,
        c.borndate,
        c.company AS companyName,
        c.position,
        c.source,
        c.status,
        c.notes AS salesRemark,
        c.sdr_status AS sdrStatus,
        c.sdr_notes AS sdrNotes,
        c.assignee_id AS assigneeId,
        c.creator_id AS creatorId,
        c.last_follow_up_time AS lastFollowUpTime,
        c.create_time AS createTime,
        c.update_time AS updateTime,
        c.is_pool AS isPool,
        c.pool_time AS poolTime,
        c.activity_id AS activityId
        FROM customers c
        WHERE c.id = #{customerId}
    </select>


    <!-- 根据客户ID查询订单 -->
    <select id="getOrdersByCustomerId" parameterType="long" resultType="com.csi.domain.vo.OrderVO">
        SELECT
        o.id,
        o.customer_id AS customerId,
        o.order_number AS orderNumber,
        o.opportunity_id AS opportunityId,
        o.total_amount AS totalAmount,
        o.signed_date AS signedDate,
        o.order_status AS orderStatus,
        o.file_url AS fileUrl,
        o.notes,
        o.create_time AS createTime
        FROM orders o
        WHERE o.customer_id = #{customerId}
    </select>


    <!-- 根据客户ID查询商机 -->
    <select id="getOpportunitiesByCustomerId" parameterType="long" resultType="com.csi.domain.vo.OpportunityVO">
        SELECT
        op.id,
        op.customer_id AS customerId,
        op.name AS name,                       -- 商机名称
        op.amount,
        op.stage,
        op.probability,                        -- 赢率
        op.expected_close_date AS expectedCloseDate, -- 预计成交日期
        op.assignee_id AS assigneeId,
        op.description,
        op.create_time AS createTime,
        op.update_time AS updateTime
        FROM opportunities op
        WHERE op.customer_id = #{customerId}
    </select>

    <!-- 更新客户表，分配给员工 -->
    <update id="updateAssigneeAndPool">
        UPDATE customers
        SET is_pool = 0,
        assignee_id = #{employeeId},
        update_time = NOW()
        WHERE id = #{customerId}
    </update>

    <select id="selectCustomerPoolList" resultType="com.csi.domain.vo.CustomerPoolVO">
        SELECT
        c.id,
        c.name,
        c.phone,
        CASE c.sex WHEN '1' THEN '男' WHEN '0' THEN '女' ELSE '未知' END AS sex,
        c.company AS companyName,
        c.position,
        p.reason AS reason,
        c.notes AS sales_remark,
        p.create_time AS pool_create_time,
        c.last_follow_up_time AS last_follow_time,
        c.create_time,
        c.update_time
        FROM customers c
        JOIN public_customer_pool p ON c.id = p.customer_id
        ORDER BY p.create_time DESC
    </select>





    <update id="updateAssignee" parameterType="map">
        UPDATE customers
        SET assignee_id = #{employeeId},
        update_time = NOW()
        WHERE id = #{customerId}
    </update>

    <update id="lockCustomer">
        UPDATE customers
        SET
        assignee_id = #{employeeId},
        is_pool = 0,
        update_time = NOW()
        WHERE id = #{customerId}
        AND is_pool = 1
    </update>


</mapper>
