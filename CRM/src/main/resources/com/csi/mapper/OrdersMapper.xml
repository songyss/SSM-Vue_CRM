<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csi.mapper.OrdersMapper">

    <!--生成订单-->
    <insert id="addOrders" parameterType="com.csi.domain.Orders">
        INSERT INTO orders (
        order_number,
        file_url,
        notes,
        opportunity_id,
        customer_id,
        total_amount,
        signed_date,
        order_status
        ) VALUES (
        #{orderNumber},
        #{fileUrl},
        #{notes},
        #{opportunityId},
        #{customerId},
        #{totalAmount},
        #{signedDate},
        #{orderStatus}
        )
    </insert>

    <!--根据ID查询订单详情-->
    <select id="selectOrderById" resultType="com.csi.domain.Orders">
        SELECT
            o.id,
            o.order_number,
            o.opportunity_id,
            o.customer_id,
            o.total_amount,
            o.signed_date,
            o.order_status,
            o.file_url,
            o.notes,
            o.create_time,
            c.name as customer_name,
            op.name as opportunity_name
        FROM orders o
        LEFT JOIN customers c ON o.customer_id = c.id
        LEFT JOIN opportunities op ON o.opportunity_id = op.id
        WHERE o.id = #{id}
    </select>

<!--按订单查询订单-->
    <select id="getOrdersStatus" resultType="com.csi.domain.Orders">
        SELECT
            orders.id as order_id,
            orders.order_number,
            orders.total_amount,
            orders.signed_date,
            orders.order_status,
            orders.file_url,
            orders.notes,
            orders.create_time,
            c.name as customer_name,
            o.name as opportunity_name,
            os.order_status_name
        FROM orders
        LEFT JOIN order_status os ON orders.order_status = os.order_status_id
        LEFT JOIN customers c ON orders.customer_id = c.id
        LEFT JOIN opportunities o ON orders.opportunity_id = o.id
        WHERE orders.order_status = ?
    </select>
    <update id="updateOrdersStatus" >
        update orders set order_status = #{status} where id = #{id}
    </update>

    <select id="selectPersonalOrders" resultType="com.csi.domain.Orders">
        select * from orders where customer_id = #{id}
    </select>

    <!-- 查询所有订单 -->
    <select id="selectAllOrders" resultType="com.csi.domain.Orders">
        SELECT
            orders.id,
            orders.order_number,
            orders.total_amount,
            orders.signed_date,
            orders.order_status,
            orders.file_url,
            orders.notes,
            orders.create_time,
            c.name as customer_name,
            o.name as opportunity_name,
            os.order_status_name
        FROM orders
        LEFT JOIN order_status os ON orders.order_status = os.order_status_id
        LEFT JOIN customers c ON orders.customer_id = c.id
        LEFT JOIN opportunities o ON orders.opportunity_id = o.id
        ORDER BY orders.id DESC
    </select>

    <!-- 根据条件查询订单 -->
    <select id="selectOrdersByCondition" resultType="com.csi.domain.Orders">
        SELECT
            orders.id,
            orders.order_number,
            orders.total_amount,
            orders.signed_date,
            orders.order_status,
            orders.file_url,
            orders.notes,
            orders.create_time,
            c.name as customer_name,
            o.name as opportunity_name,
            os.order_status_name
        FROM orders
        LEFT JOIN order_status os ON orders.order_status = os.order_status_id
        LEFT JOIN customers c ON orders.customer_id = c.id
        LEFT JOIN opportunities o ON orders.opportunity_id = o.id
        <where>
            <if test="orderNo != null and orderNo != ''">
                AND orders.order_number LIKE CONCAT('%', #{orderNo}, '%')
            </if>
            <if test="status != null and status != ''">
                AND orders.order_status = #{status}
            </if>
            <if test="startDate != null and startDate != ''">
                AND orders.signed_date &gt;= #{startDate}
            </if>
            <if test="endDate != null and endDate != ''">
                AND orders.signed_date &lt;= #{endDate}
            </if>
        </where>
        ORDER BY orders.id DESC
    </select>

</mapper>